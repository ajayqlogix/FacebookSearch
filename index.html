<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
  <script>

  $(function() {
    var q = decodeURIComponent(document.location.search.split(/=/)[1] || 'rectal surgery').replace(/\+/g,' ');

    var ROW_HTML=['',
    '<tr>',
    '  <td class="person">',
    '    <a href="http://www.facebook.com/profile.php?id=ID&v=wall" target="_blank"><img class="profile" src="http://graph.facebook.com/ID/picture"/><br>NAME</a>',
    '  </td>',
    '<td class="msg"><q>MSG</q></td>',
    '<td class="dump"><pre>DUMP</pre></td>',
    '</tr>'].join('\n');
    
    $('#q').attr('value',q);
    
    $(window).scroll(function(){
            if  ($(window).scrollTop() == $(document).height() - $(window).height()){
               fetchNextPage();
            }
    });
    
    var nextPage;
    function fetchNextPage() {
        if (nextPage)
            $.getJSON(nextPage + "&callback=?", handleSearchResults);
    }
    
    $.getJSON( 'http://graph.facebook.com/search?callback=?', {'q':q, 'type':'post'}, handleSearchResults);
    
    function handleSearchResults(response, textStatus) {
      //console.warn(response);
      
      if (response.paging && response.paging.next)
          nextPage = response.paging.next;
      else
        $(".waitloading").hide();
      jQuery.each(response.data,function(_,post) {
        var html = ROW_HTML
        .replace(/ID/g,  post.from.id)
        .replace(/NAME/g,post.from.name)
        .replace(/MSG/g, post.message||'');
        
        $.getJSON("http://graph.facebook.com/" + post.from.id + "?callback=?", function(user) {
            var creepy = "";
            if (user.gender)
                creepy += user.gender + " ";
            if (user.location && user.location.name)
                creepy += "from " + user.location.name + " ";
            html = html.replace(/DUMP/, creepy);
            
            $(html).appendTo($('table'));
        })
      });
    }
  });
  </script>

  <title>Facebook Search</title>

  <style>
  #header { background-color: #F0F0F0; border-bottom: 1px solid #CCC; padding: 1em;}
  a { text-decoration:none; }
  img.profile { border: thin solid gray; padding: 2px; width: 50px; height: 50px; }
  ul { list-style:none; }
  td { padding-bottom:2em; vertical-align: top; font-family: Tahoma, sans-serif; font-size: 13px;}
  td.person { width:80px; text-align:center;}
  td.msg { width:30em; }
  </style>
</head>
<body>
  <div id="header">
    <form action="">
      <label>Search Facebook: <input id="q" name="q" type="text"/></label>
      <input type="submit" value="Go!"/>
    </form>
  </div>

  <div id="body">
    <table></table>
  </div>
  
  <div id="footer">
      <img src='spinner.gif' class='waitloading'>
  </div>    
</body>
</html>
